---
layout: post
title: XenServer PowerShell and Windows 7 (Getting it to work)
---


<p>As I recently have rebuilt my laptop to run Windows 7 RC, I decided to download and install the XenServer Powershell extensions (<a href="http://community.citrix.com/cdn/xs/sdks/" target="_blank">available here</a>) to start evaluating them. I was going to start writing my own extension but then stumbled across the ones that Citrix has developed and figured instead of writing my own, I would post some videos pertaining to the Citrix distributed ones. As a side not, Citrix has also released the source code to the PowerShell extensions. A very cool move in my humble opinion. I believe more companies should contribute to the open source community, and props to Citrix for taking this step.</p>  <p>After the installation, I checked the readme and saw an important item</p>  <p>“3.&#160; Determine the current execution policy, like this:    <br />&#160;&#160;&#160; PS&gt; Get-ExecutionPolicy</p>  <p>&#160;&#160;&#160; If the current policy is Restricted, then you need to set it to    <br />&#160;&#160;&#160; RemoteSigned, like this:     <br />&#160;&#160;&#160; PS&gt; Set-ExecutionPolicy RemoteSigned     <br />&#160;&#160;&#160; You should understand the security implications of this change.&#160; If you     <br />&#160;&#160;&#160; are unsure, see Microsoft's documentation on the matter:     <br />&#160;&#160;&#160; PS&gt; Get-Help about_signing     <br />&#160;&#160;&#160; If the current policy is AllSigned, then this will work, but will be     <br />&#160;&#160;&#160; very inconvenient.&#160; You probably want to change this to RemoteSigned,     <br />&#160;&#160;&#160; as above.     <br />&#160;&#160;&#160; If the current policy is Unrestricted or RemoteSigned, then this is     <br />&#160;&#160;&#160; compatible with XS-PS, so there is nothing to do.”</p>  <p>After adhearing to the above documentation ;), lets go ahead and run the XenServer Powershell Snapin from the start menu.    <br /><a href="http://www.sharepoint-stuff.com/wp-content/uploads/2009/05/image.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://www.sharepoint-stuff.com/wp-content/uploads/2009/05/image-thumb.png" width="422" height="192" /></a></p>  <p>The resulting output from powershell is the below screenshot. Basically Powershell is telling us that it cannot find the XenServerPSSnapIn snapin, which typically means that the xenserverpssnap dll did not get registered properly during the installation. At least that is the initial theory :)</p>  <p><a href="http://www.sharepoint-stuff.com/wp-content/uploads/2009/05/image1.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://www.sharepoint-stuff.com/wp-content/uploads/2009/05/image-thumb1.png" width="1000" height="644" /></a></p>  <p>Maybe we need to run the installer as administrator, sometimes I forget to do this, but I thought this might be an issue so lets make sure and reinstall as admin. Well, that didnt work in my case so on to the original theory.</p>  <p>To make sure that this is indeed the case, lets fire up Microsoft Orca (MSI Editor tool) and edit the XenServerPSSnapIn-5.0.0-3.msi to see if we can find a custom action or something that takes care of the registration process. After searching around within the MSI indeed there is a custom action that is supposed to register the xenserver snapin on the machine as shown below.</p>  <p><a href="http://www.sharepoint-stuff.com/wp-content/uploads/2009/05/image2.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://www.sharepoint-stuff.com/wp-content/uploads/2009/05/image-thumb2.png" width="1142" height="358" /></a></p>  <p>To further confirm that the snapin did not get registered during the installation process let check the registry. You can locate all registered PowerShell snapins by checking the following key    <br />HKEY_LOCAL_MACHINESOFTWAREMicrosoftPowerShell1PowerShellSnapIns</p>  <p><a href="http://www.sharepoint-stuff.com/wp-content/uploads/2009/05/image3.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://www.sharepoint-stuff.com/wp-content/uploads/2009/05/image-thumb3.png" width="425" height="284" /></a></p>  <p><font color="#000080"><strong><u>Side Note:</u></strong> If your developing PowerShell snapins using C#/VB.Net once you compile your snapin dll you will need inform PowerShell that it is installed on the the machine and you want to load it into PowerShell. This is a two step process.       <br />Step 1: use the installutil.exe utility to register the DLL onto the system the syntax is something similar to the following       <br />%windir%Microsoft.NetFrameworkv2.0.50727installutil.exe [full path to your dll]</font></p>  <p><font color="#000080">Step 2: once you have registered your dll on the system you need to add it to Powershell. You can do this by issuing the Add-PSSnapIn command from within powershell, like the following      <br />Add-PSSnapIn –name [Your SnapIn Name]</font></p>  <p>&#160;</p>  <p>So, now we know what the problem is we can work on fixing it so we can start using the SnapIns :)</p>  <p>The first step in the process is to register the snapin DLL on the the machine. Check out the side note above. We can achieve this by issuing the following command from within powershell. (Note: You will need to run PowerShell as administrator, especially if you are running on Windows 7).    <br />C:WindowsMicrosoft.NETFramework64v2.0.50727InstallUtil.exe [Path To XenServer DLL]XenServerPSSnapIn.dll</p>  <p>Once issuing this command you should see something like the following screenshot.</p>  <p><a href="http://www.sharepoint-stuff.com/wp-content/uploads/2009/05/image4.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://www.sharepoint-stuff.com/wp-content/uploads/2009/05/image-thumb4.png" width="999" height="451" /></a></p>  <p>Now, from here you should be able to execute the XenServer Powershell Snapin from the start menu, and you will get the resulting powershell window ,with the snapin registered and ready to go, like the following. As you can see we have connected to out test XenServer    <br /><a href="http://www.sharepoint-stuff.com/wp-content/uploads/2009/05/image5.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://www.sharepoint-stuff.com/wp-content/uploads/2009/05/image-thumb5.png" width="688" height="348" /></a></p>  <p>To further show that the the snapin is indeed loaded, we can issue the command Get-PSSnapin and it will show that the XenServer snapin is loaded.    <br /><a href="http://www.sharepoint-stuff.com/wp-content/uploads/2009/05/image6.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://www.sharepoint-stuff.com/wp-content/uploads/2009/05/image-thumb6.png" width="679" height="345" /></a></p>  <p>&#160;</p>  <p>Now, if you want to load the snapin into a regular powershell window, you would need to issue the Add-PSSnapIn command and that will load up the snapin for use within the current powershell window, like the following    <br />Add-PSSnapin XenServerPSSnapIn     <br /><a href="http://www.sharepoint-stuff.com/wp-content/uploads/2009/05/image7.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://www.sharepoint-stuff.com/wp-content/uploads/2009/05/image-thumb7.png"
width="746" height="161" /></a></p>  <p>This will load the snapin and make the commands available for you to use.</p>  <p>&#160;</p>  <p>Now, at this point, I’m not sure why the install did not properly register the XenServerSnapin.Dll on my Windows 7 RC system, but I am trying to do some further research on this and as soon I find out more info I will post it here. I hope this post helps out.</p>  <p>As always you can reach me through comments on here, follow me on twitter (<a href="http://www.twitter.com/johnmcbride">http://www.twitter.com/johnmcbride</a>) or friend me on FaceBook.</p>
