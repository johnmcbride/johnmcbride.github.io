---
layout: post
title: How to fix the slow load times when using the VMWare WebServices API in C#.
---


<p>While writing some VMWare SDK/Web Services howto posts as well as some production code in C# I recently ran into an issue where the vimService object was taking upwards for 3 minutes to instantiate.</p>  <p>I figured that I might have messed up on adding the web service reference, so I re-added the web service reference to the project by select “Add Web Reference”, then when it asked for the WSDL location put in our ESX server location. ie. <a href="https://&lt;server&gt;/sdk/vimService?wsdl">/sdk/vimService?wsdl&quot;&gt;/sdk/vimService?wsdl&quot;&gt;https://&lt;server&gt;/sdk/vimService?wsdl</a>. Everything should be be good with this right? Wrong… Just by doing this the vimService takes forever to load.</p>  <p>After some researching it turns out that this is somewhat of a known issue, and has to do with the XmlSerialization object in .NET 2.0 and above (Apparently this works fine with .NET 1.1, but that doesn’t really help me out to much :)</p>  <p>In order to use this web service successfully and have acceptable load times, you are going to have to create the proxy DLL manually, and do some modification of the class that gets gen’d from the wsdl.exe. Since I am putting together some howto posts using the VMWare SDK/Web Services I thought I would put together this post, to document the steps to create a workable proxy DLL that can be used in any .NET projects (c# or VB.net)</p>  <p>Here are a couple of video’s to show the response time. I didn’t edit the first video so there is a lot of dead air :)</p>  <p><u>Accessing the VIMService object (SLOW…..)</u></p>  <p><object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"<br /> codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"<br /> WIDTH="500" HEIGHT="500" id="slowVMService"><param NAME="movie" VALUE="http://www.sharepoint-stuff.com/wp-content/uploads/2009/02/vmwaresdk_vimserviceslow.swf"></object></p>  <p>&#160;</p>  <p><u>Accessing the VIMService object with the modified proxy object. Pretty snappy….</u></p>  <p><object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"<br /> codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"<br /> WIDTH="400" HEIGHT="330" id="slowVMService"><param NAME="movie" VALUE="http://www.sharepoint-stuff.com/wp-content/uploads/2009/02/vmwaresdk_vimservicefaster.swf"></object></p>  <p>Step 1. Download and install the VMWare SDK from the following location <a href="http://www.vmware.com/download/sdk/">http://www.vmware.com/download/sdk/</a>. You want to get the SDK titled “VMware Infrastructure SDK Packages”</p>  <p>Step 2. We are going to want to generate a source file from the WSDL files that come included with the SDK. Remember from my earlier comment that you cannot add this as a web reference from Visual Studio or you will suffer from the slow load time). With that being said, we need to navigate to the location of the wsdl files. These should be located in c:&lt;SDKInstalledFolder&gt;sdkwsdlvim25 folder. NOTE: I am assuming here that you are using ESX 2.5 or above. If you are using a lower version be sure to use the wsdl files in the vim folder instead.</p>  <p>To generate the source file issue the following command</p>  <p>wsdl.exe vim.wsdl vimService.wsdl</p>  <p>By default this will create a VimService.cs file in the same directory.</p>  <p><a href="http://www.sharepoint-stuff.com/wp-content/uploads/2009/02/image.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://www.sharepoint-stuff.com/wp-content/uploads/2009/02/image-thumb.png" width="681" height="394" /></a></p>  <p>Step 3. After we have generated the source file we need to compile that into a library so that the proxy can be used in&#160; visual studio. To compile the source file issue the following command.</p>  <p>csc.exe /t:library /out:VimService.dll VimService.cs</p>  <p><a href="http://www.sharepoint-stuff.com/wp-content/uploads/2009/02/image1.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://www.sharepoint-stuff.com/wp-content/uploads/2009/02/image-thumb1.png" width="681" height="394" /></a></p>  <p>Step 4. Here is where is gets a little unusual. After we have created the DLL we are going to need to run a .NET utility called sgen on it.</p>  <p>SideBar: sgen.ee is a tool that comes with the .NET SDK. Running this tool on a specific assembly will create a XML serialization assembly for the the types in the given assembly. This helps improve load performance of said assembly.</p>  <p>To run sgen on the newly created dll, issue the following command.</p>  <p>sgen.exe /p VimService.dll</p>  <p>Note: This process make take a few minutes :)</p>  <p><a href="http://www.sharepoint-stuff.com/wp-content/uploads/2009/02/image2.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://www.sharepoint-stuff.com/wp-content/uploads/2009/02/image-thumb2.png" width="681" height="394" /></a></p>  <p>Step 5. The next step in the process is to modify the actual source file that got created from the WSDL.exe command. Using you favorite text editor open up the&#160; vimService.cs file and comment out all lines that start with [System.Xml.Serialization.</p>  <p>You can do a search and replace and search for [System.Xml.Serialization.XmlIncludeAttribute</p>  <p>and replace with</p>  <p>//[System.Xml.Serialization.XmlIncludeAttribute</p>  <p>In the end, you should end up with something like this (Note there are about 3,162 occurrences)</p>  <p><a href="http://www.sharepoint-stuff.com/wp-content/uploads/2009/02/image21.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://www.sharepoint-stuff.com/wp-content/uploads/2009/02/image21-thumb.png" width="746" height="43" /></a></p>  <p><a href="http://www.sharepoint-stuff.com/wp-content/uploads/2009/02/image15.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://www.sharepoint-stuff.com/wp-content/uploads/2009/02/image15-thumb.png" width="1059" height="861" /></a></p>  <p>Step 6. After commenting out the System.Xml.Serialization we are going to need to add an additional attribute on the VimService class in the source file. Open the vimService.cs in your favorite text editor, find the following line    <br />public partial class VimService : System.Web.Services.Protocols.SoapHttpClientProtocol {</p>  <p>and right before it add this</p>  <p>[System.Xml.Serialization.XmlSerializerAssemblyAttribute(AssemblyName = &quot;VimService.XmlSerializers&quot;)]</p>  <p>It should resemble the following<a href="http://www.sharepoint-stuff.com/wp-content/uploads/2009/02/image3.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" title="image" border="0" alt="image" src="http://www.sharepoint-stuff.com/wp-content/uploads/2009/02/image-thumb3.png" width="877" height="51" /></a></p>  <p>This will make your source file ready for compilation again. :)</p>  <p>Step 7. The last step in this process is to recompile the source file once again and create a new library for use within Visual Studio.</p>  <p>Run the following command</p>  <p>csc.exe /t:library /out:VimService.dll VimService.cs</p>  <p>And you should a shiny new dll ready for use within your .NET projects and without the unbearable load times of the vimService object.</p>  <p><a href="http://www.sharepoint-stuff.com/wp-content/uploads/2009/02/image4.png"><img style="border-right-width: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px"
title="image" border="0" alt="image" src="http://www.sharepoint-stuff.com/wp-content/uploads/2009/02/image-thumb4.png" width="681" height="394" /></a></p>  <p>And with that, I’m OUT!</p>
